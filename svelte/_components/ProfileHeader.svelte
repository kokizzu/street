<script>
    // @ts-nocheck
    import {T, isSideMenuOpen, langOptions} from './uiState.js';
    import Icon from 'svelte-icons-pack/Icon.svelte';
    import FaSolidBars from 'svelte-icons-pack/fa/FaSolidBars';
    import FaSolidPowerOff from "svelte-icons-pack/fa/FaSolidPowerOff";
    import {onMount} from 'svelte';
    import {UserUpdateProfile, UserLogout} from '../jsApi.GEN.js';

    export let user = null;
    export let access = {
        'admin': false,
        'buyer': false,
        'realtor': false,
        'user': false,
    };

    function openSideMenu() {
        isSideMenuOpen.set(!$isSideMenuOpen);
    }

    let selectedLanguage = '';
    onMount(() => {
        console.log('onMount.ProfileHeader =', user)
        selectedLanguage = T.currentLang || 'EN';
    });

    async function updateLang() {
        if (user !== null && user.language !== selectedLanguage) {
            user.language = selectedLanguage;
            await UserUpdateProfile(user, function(res) {
                if (res.error) return console.log('error')
                user = res.user;
            });
        }
    }

    $: {
        T.changeLanguage(selectedLanguage, async () => await updateLang());
    }

    let showLogoutMenu = false;
    async function userLogout() {
        await UserLogout( {}, function( o ) {
            console.log( o );
            if( o.error ) return alert( o.error );
            window.location = '/';
        } );
    }
</script>

<header class='profile_header'>
    <nav class='navbar'>
        <div class='label_menu'>
            {#if access.admin}
                <button on:click|preventDefault={openSideMenu}>
                    <Icon color='#FFF' size={20} src={FaSolidBars}/>
                </button>
            {/if}
            {#if !access.admin}
                <button on:click|preventDefault={() => showLogoutMenu = !showLogoutMenu}>
                    <Icon color='#FFF' size={20} src={FaSolidPowerOff}/>
                </button>
            {/if}
            <p>HapSTR</p>
            {#if showLogoutMenu}
            <div class="logout_menu">
                <button on:click|preventDefault={userLogout}>
                    Logout
                </button>
                <button on:click|preventDefault={() => showLogoutMenu = !showLogoutMenu}>
                    Cancel
                </button>
            </div>
            {/if}
        </div>
        <div class='right_nav'>
            <select bind:value={selectedLanguage} id='lang' name='lang'>
                {#each Object.values(langOptions) as lang}
                    <option value={lang}>{lang}</option>
                {/each}
            </select>
            <button class='profile_button' on:click={userLogout} title='Click to logout'>
                <img alt='profile' src='/assets/img/team-1-200x200.jpg'/>
            </button>
        </div>
    </nav>
</header>

<style>
    .profile_header {
        background-color : #EF4444;
        height           : fit-content;
        position         : relative;
        padding          : 18px 50px 80px 50px;
        display          : flex;
        flex-direction   : column;
    }

    .profile_header .navbar {
        display         : flex;
        flex-direction  : row;
        justify-content : space-between;
        align-items     : center;
    }

    .profile_header .navbar .label_menu {
        display        : flex;
        flex-direction : row;
        align-items    : center;
        color          : white;
        position: relative;
    }

    .profile_header .navbar .label_menu .logout_menu {
        display: flex;
        flex-direction: column;
        border-radius: 8px;
        filter        : drop-shadow(0 10px 8px rgb(0 0 0 / 0.04)) drop-shadow(0 4px 3px rgb(0 0 0 / 0.1));
        
        background-color: #FFF;
        color: #475569;
        position: absolute;
        z-index: 800;
        border: 1px solid #CBD5E1;
        height: fit-content;
        width: fit-content;
        top: 50px;
    }

    .profile_header .navbar .label_menu .logout_menu button {
        border: none;
        background-color: transparent;
        padding: 0;
        color: #475569;
        font-weight: 600;
        padding: 9px 17px;
    }

    .profile_header .navbar .label_menu .logout_menu button:nth-child(1) {
        color: #EF4444;
    }

    .profile_header .navbar .label_menu .logout_menu button:hover {
        background-color: #F1F5F9;
    }

    .profile_header .navbar .label_menu button {
        padding       : 10px;
        border        : none;
        background    : none;
        border-radius : 5px;
        font-size     : 14px;
        color         : white;
        cursor        : pointer;
    }

    .profile_header .navbar .label_menu button:hover {
        background-color : rgba(255, 255, 255, 0.3);
    }

    .profile_header .navbar .label_menu p {
        font-size   : 17px;
        font-weight : 600;
        line-height : 1.5rem;
        padding     : 0;
        margin      : 0 0 0 15px;
    }

    .profile_header .navbar .right_nav {
        display        : flex;
        flex-direction : row;
        gap            : 30px;
        align-items    : center;
    }

    .profile_header .navbar #lang {
        padding       : 6px 8px;
        width         : 60px;
        border        : none;
        border-radius : 5px;
        color         : #1080E8;
        font-weight   : 600;
        cursor        : pointer;
        filter        : drop-shadow(0 10px 8px rgb(0 0 0 / 0.04)) drop-shadow(0 4px 3px rgb(0 0 0 / 0.1));
    }

    .profile_header .navbar #lang:hover {
        background-color : #F1F5F9;
    }

    .profile_header .navbar #lang:focus {
        outline : none;
    }

    .profile_header .navbar .right_nav .profile_button {
        padding       : 0;
        border        : none;
        margin        : 0;
        width         : fit-content;
        height        : fit-content;
        border-radius : 50%;
        filter        : drop-shadow(0 10px 8px rgb(0 0 0 / 0.04)) drop-shadow(0 4px 3px rgb(0 0 0 / 0.1));
    }

    .profile_header .navbar .right_nav .profile_button:hover {
        box-shadow : 0 0 0 3px rgba(255, 255, 255, 0.5);
        cursor     : pointer;
    }

    .profile_header .navbar .right_nav .profile_button > img {
        width         : 50px;
        height        : 50px;
        border-radius : 9999px;
    }

    /* Responsive to mobile device */
    @media only screen and (max-width : 768px) {
        .profile_header {
            padding : 15px 20px 80px 20px !important;
        }

        .profile_header .navbar .label_menu button {
            padding : 0;
        }

        .profile_header .navbar .right_nav {
            gap : 10px;
        }

        .profile_header .navbar #lang {
            padding   : 3px 5px;
            font-size : 12px;
            width     : 50px
        }

        .profile_header .navbar .right_nav .profile_button > img {
            width  : 40px;
            height : 40px;
        }

        .profile_header .navbar .label_menu .logout_menu {
            top: 30px;
        }
    }
</style>
